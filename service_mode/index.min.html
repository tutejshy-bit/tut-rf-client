<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{font-family:Monaco,monospace}h1{color:#b5e853;font-size:30px;text-align:center}h3{margin-bottom:0}body{background:#1a1a1a;margin:0;padding:0;color:#fff}.content{max-width:800px;margin:20px auto;padding:0 20px;box-sizing:border-box}.editor{width:100%;background:#121212;color:#fff;border:1px solid #000;box-shadow:0 10px 10px 2px #0003;padding:20px;box-sizing:border-box}.line{display:flex;justify-content:space-between;align-items:flex-start;padding:10px 0}.param{color:#b5e853;width:150px;text-align:left}.vc{flex-grow:1;display:flex;flex-direction:column}.value,input[type=file],input[type=password],input[type=text],select,select.value{width:100%;background:#1a1a1a;color:#fff;border:1px solid #b5e853;padding:10px;box-sizing:border-box}input[type=file]{width:250px;height:35px;padding:7px 10px}input[type=file]::file-selector-button{background:#1a1a1a;color:#b5e853;border:0}input[type=file]::file-selector-button:hover{background:#b5e853;color:#1a1a1a;cursor:pointer}.tip{color:#6cbdec;font-size:12px;margin-top:5px;width:100%}.tip.invalid{color:#e85353}input[type=button],input[type=file]{cursor:pointer;margin-top:20px}input[type=button]{background:#1a1a1a;color:#b5e853;border:1px solid #b5e853;height:35px;max-width:300px}input[type=button]:hover{background:#b5e853;color:#1a1a1a}.pbc{display:flex;align-items:center;margin-top:10px}.pb{width:100%;height:20px;background-color:#ddd;border-radius:10px;overflow:hidden;position:relative}.pbf{width:0;height:100%;background-color:#b5e853;transition:width .2s}.pp{margin-left:10px;color:#b5e853;font-weight:700;white-space:nowrap}.hidden{display:none}.bc{display:flex;justify-content:space-between;margin-top:20px}.bc input[type=button]{max-width:48%}#us{margin-left:auto}#ol{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;cursor:not-allowed}#cf,.pbc{position:relative;z-index:1001}@media (max-width:660px){.line{flex-wrap:wrap;justify-content:flex-start}.param,.vc{width:100%}}</style></head><body><h1>Service Mode</h1><div class="content"><input type="button" id="su" value="Update Firmware"></div><div class="content hidden" id="fs"><h3>Firmware Upload</h3><input type="file" id="ff" accept=".bin"> <input type="button" id="uf" value="Upload Firmware"><div class="pbc hidden" id="pb"><div class="pb"><div class="pbf"></div></div><div class="pp">0%</div></div><input type="button" id="cf" class="hidden" value="Cancel Firmware Update"></div><div class="content"><h3>Edit Settings</h3><div id="editor" class="editor"></div><div class="bc"><input type="button" id="rc" value="Reset Config"> <input type="button" id="us" value="Update Settings"></div></div><div id="ol" class="hidden"></div><script>const t=["300","1200","2400","4800","9600","19200","38400","57600","74880","115200","230400","250000"];const l={wifi_mode:{tip:"WiFi mode can be either 'ap' for Access Point or 'client'.",validate:e=>["ap","client"].includes(e),type:"select",options:["ap","client"]},ssid:{tip:"SSID of the WiFi network.",validate:e=>e.length>0,type:"text"},password:{tip:"Must be at least 8 characters.",validate:e=>e.length>=8,type:"text"},serial_baud_rate:{tip:"Baud rate for serial monitor",validate:e=>t.includes(e),type:"select",options:t}};const c=e=>{let n=null;if(typeof e==="string"){const t=e.charAt(0)==="#"||/^[a-zA-Z0-9_-]+$/.test(e);n=document.querySelector(t&&e.charAt(0)!=="#"?`#${e}`:e)}else if(e instanceof HTMLElement){n=e}return{el:n,hide(){if(n)n.classList.add("hidden");return this},show(){if(n)n.classList.remove("hidden");return this},on(e,t){if(n)n.addEventListener(e,t);return this},text(e){if(n)n.textContent=e;return this},css(e,t){if(n)n.style[e]=t;return this},addClass(e){if(n)n.classList.add(e);return this},removeClass(e){if(n)n.classList.remove(e);return this},create(e){return c(document.createElement(e))},append(e){if(n)n.appendChild(e.el||e);return this}}};let d={};let s,i,a=0,r=1024,o=0;function n(){const o=c("editor").el;o.innerHTML="";Object.entries(d).forEach(([e,n])=>{const t=c().create("div").addClass("param").text(e);let s;if(l[e].type==="select"){s=c().create("select").addClass("value");l[e].options.forEach(e=>{const t=c().create("option").text(e).el;s.append(t);if(e===n)t.selected=true})}else{s=c().create("input").addClass("value").css("type","text");s.el.value=n;s.el.dataset.param=e}const i=c().create("div").addClass("tip").text(l[e].tip);const a=c().create("div").addClass("vc").append(s.el).append(i.el);const r=c().create("div").addClass("line").append(t.el).append(a.el);s.on("blur",()=>{d[e]=s.el.value;v(e,s.el,i.el)});o.appendChild(r.el)})}function e(){c("ol").show().text("Connecting");s=new WebSocket("ws://192.168.4.1/ws");s.onopen=()=>{c("fs").show();c("su").hide();u()};s.onclose=s.onerror=()=>{alert("Device is not available. Please try again.");c("fs").hide();c("su").show();u()};s.onmessage=e=>{const t=e.data;const n=e=>t.startsWith(e);if(n("ota_ready_for_chunk")){f()}else if(n("progress:")){const s=parseFloat(t.split(":")[1]);p(s)}else if(n("ota_success")){p(100);alert("OTA Update Complete! Rebooting...");u()}else if(n("ota_error")){alert("Error: "+t.split(":")[1]);u()}else if(n("ota_canceled")){alert("OTA Update Canceled.");u()}}}function f(){const e=Math.min(r,a-o);let t=new FileReader;let n=i.slice(o,o+e);t.onload=function(){s.send(t.result);o+=e;if(o>=a){s.send("ota_end")}};t.readAsArrayBuffer(n)}function u(){i=null;a=0;o=0;isServerReadyForChunk=false;p(0);c("cf").hide();c("pb").hide();c("ol").hide().text("")}function p(e){c(".pbf").css("width",e+"%");c(".pp").text(e+"%")}g();c("su").on("click",e);c("cf").on("click",()=>confirm("Are you sure you want to cancel the firmware update?")&&s.send("cancel_ota"));c("uf").on("click",()=>{const e=c("ff").el;if(e.files.length===0)return alert("Please select a firmware file.");c("pb").show();c("ol").show();h(e.files[0])});function h(e){i=e;a=e.size;s.send("start_ota:"+a);c("cf").show()}function g(){fetch("http://192.168.4.1/get_config").then(e=>e.text()).then(e=>{d=e.split("\n").reduce((e,t)=>{const[n,s]=t.split("=");if(n&&s)e[n.trim()]=s.trim();return e},{});n()})["catch"](console.error)}function v(e,t,n){const s=l[e].validate(t.value);if(n)n.classList.toggle("invalid",!s);return s}function m(){return Object.entries(l).reduce((e,[t,n])=>{const s=c(`input[data-param="${t}"]`).el;if(s){const i=s.nextElementSibling;const a=n.validate(s.value);i.classList.toggle("invalid",!a);return e&&a}return e},true)}c("us").on("click",()=>{if(!m())return alert("Please correct the highlighted fields.");const n=new URLSearchParams;Object.entries(d).forEach(([e,t])=>n.append(e,t));fetch("http://192.168.4.1/set_config",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}).then(e=>{alert(e.ok?"Settings saved successfully.":"Failed to save settings.");g()})["catch"](console.error)});c("rc").on("click",()=>confirm("Are you sure you want to reset the configuration to default settings?")&&w());function w(){fetch("http://192.168.4.1/reset_config").then(e=>{if(e.ok){alert("Configuration has been reset to default settings.");g()}else{alert("Failed to reset configuration.")}})["catch"](e=>console.error("Error resetting configuration:",e))}</script></body></html>